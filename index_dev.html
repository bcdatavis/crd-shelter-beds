<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CRD Shelter Beds</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }

        /* Left-aligned title bar */
        #title-bar {
            background: #f7f7f7;
            padding: 10px 15px;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        #map {
            width: 100%;
            height: calc(100vh - 40px);
        }

        #layer-toggle-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            font-size: 14px;
        }

        #layer-toggle-header {
            background: white;
            padding: 6px 10px;
            border-radius: 4px;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
            cursor: pointer;
            user-select: none;
        }

        #layer-toggle-content {
            background: white;
            margin-top: 5px;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        /* Hide layer content by default if collapsed */
        .collapsed #layer-toggle-content {
            display: none;
        }

        #toggle-arrow {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        .collapsed #toggle-arrow {
            transform: rotate(-90deg);
        }
        
    </style>
</head>
<body>

<!-- Title Bar -->
<div id="title-bar">CRD Shelter Beds</div>

<!-- Map -->
<div id="map"></div>

<!-- Collapsible Layer Control -->
<div id="layer-toggle-container">
    <div id="layer-toggle-header">Layers <span id="toggle-arrow">â–¼</span></div>
    <div id="layer-toggle-content">
        <strong>Shelter Beds</strong><br>
        <label><input type="radio" name="layer" value="total" checked> Total Beds</label><br>
        <label><input type="radio" name="layer" value="yr_rnd"> Year-Round Beds - All Clients 19+</label><br>
        <label><input type="radio" name="layer" value="women"> Year-Round Beds - Women 19+ only</label><br>
        <label><input type="radio" name="layer" value="youth"> Year-Round Beds - Youth (15-25)</label><br>
        <label><input type="radio" name="layer" value="temp"> Temporary Beds - All Clients 19+</label><br><br>

        <strong>Heatmap</strong><br>
        <label><input type="checkbox" id="heatmap-toggle"> Shelter Beds Heatmap</label><br><br>

        <strong>CRD Municipalities - All</strong><br>
        <label><input type="checkbox" id="municipal-boundaries" checked> Municipal Boundaries</label><br>

        <strong>CRD Municipalities - With Shelters</strong><br>
        <label><input type="checkbox" id="city-of-victoria" checked> City of Victoria</label><br>
        <label><input type="checkbox" id="district-of-saanich" checked> District of Saanich</label>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    // Toggle layer panel
    document.getElementById('layer-toggle-header').addEventListener('click', () => {
        document.getElementById('layer-toggle-container').classList.toggle('collapsed');
    });

    const map = L.map('map').setView([48.4801,-123.4085], 10);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const municipalLayer = L.tileLayer.wms('https://openmaps.gov.bc.ca/geo/pub/wms', {
        layers: 'pub:WHSE_LEGAL_ADMIN_BOUNDARIES.ABMS_MUNICIPALITIES_SP',
        styles: '410_5381',
        format: 'image/png',
        transparent: true,
        version: '1.1.1',
        srs: 'EPSG:4326',
        opacity: 0.5
    }).addTo(map);

    const totalLayer = L.layerGroup().addTo(map);
    const yrRndLayer = L.layerGroup();
    const womenLayer = L.layerGroup();
    const youthLayer = L.layerGroup();
    const tempLayer = L.layerGroup();

    const csvUrl = 'https://raw.githubusercontent.com/bcdatavis/crd-shelter-beds/refs/heads/main/data/shelter_list.csv';

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach(row => {
                const coord = row.coordinates?.trim();
                if (!coord) return;
                const [lng, lat] = coord.split(',').map(Number);
                if (isNaN(lat) || isNaN(lng)) return;

                const operator = row.operator_name || 'Unknown operator';
                const address = row.physical_address || 'Unknown address';

                const addMarker = (layer, value, color, fill) => {
                    if (!isNaN(value) && value > 0) {
                        L.circleMarker([lat, lng], {
                            radius: Math.sqrt(value),
                            color: color,
                            fillColor: fill,
                            fillOpacity: 0.8,
                            weight: 1
                        }).bindPopup(`
                            <strong>${operator}</strong><br>
                            <strong>Address:</strong> ${address}<br>
                            <strong>Beds:</strong> ${value}
                        `).addTo(layer);
                    }
                };

                addMarker(totalLayer, parseInt(row.beds_total), 'black', 'dodgerblue');
                addMarker(yrRndLayer, parseInt(row.beds_yr_rnd_all), 'black', 'red');
                addMarker(womenLayer, parseInt(row.beds_yr_rnd_women), 'black', 'deeppink');
                addMarker(youthLayer, parseInt(row.beds_yr_rnd_youth), 'black', 'gold');
                addMarker(tempLayer, parseInt(row.beds_temp), 'black', 'darkorange');
            });

            totalLayer.bringToFront();
            yrRndLayer.bringToFront();
            womenLayer.bringToFront();
            youthLayer.bringToFront();
            tempLayer.bringToFront();
        }
    });

    const layers = {
        total: totalLayer,
        yr_rnd: yrRndLayer,
        women: womenLayer,
        youth: youthLayer,
        temp: tempLayer
    };

    document.querySelectorAll('input[name="layer"]').forEach(radio => {
        radio.addEventListener('change', e => {
            Object.values(layers).forEach(layer => map.removeLayer(layer));
            const selectedLayer = layers[e.target.value];
            map.addLayer(selectedLayer);
        });
    });

    document.getElementById('municipal-boundaries').addEventListener('change', function(e) {
        if (e.target.checked) {
            map.addLayer(municipalLayer);
        } else {
            map.removeLayer(municipalLayer);
        }
    });

    const saanichLayer = L.geoJSON(null, {
        style: { color: 'green', weight: 2, opacity: 0.5 },
        interactive: false
    }).addTo(map);

    fetch('https://raw.githubusercontent.com/bcdatavis/crd-shelter-beds/refs/heads/main/data/District_of_Saanich.geojson')
        .then(response => response.json())
        .then(data => {
            saanichLayer.addData(data);
        });

    document.getElementById('district-of-saanich').addEventListener('change', function(e) {
        if (e.target.checked) {
            map.addLayer(saanichLayer);
        } else {
            map.removeLayer(saanichLayer);
        }
    });

    const victoriaLayer = L.geoJSON(null, {
        style: { color: 'green', weight: 2, opacity: 0.5 },
        interactive: false
    }).addTo(map);

    fetch('https://raw.githubusercontent.com/bcdatavis/crd-shelter-beds/refs/heads/main/data/City_of_Victoria.geojson')
        .then(response => response.json())
        .then(data => {
            victoriaLayer.addData(data);
        });

    document.getElementById('city-of-victoria').addEventListener('change', function(e) {
        if (e.target.checked) {
            map.addLayer(victoriaLayer);
        } else {
            map.removeLayer(victoriaLayer);
        }
    });

    // --- Heatmap Layer Setup ---

    let heatLayer;

    fetch('https://raw.githubusercontent.com/bcdatavis/crd-shelter-beds/refs/heads/main/data/shelter_heatmap.geojson')
        .then(res => res.json())
        .then(data => {
            // Extract points as [lat, lng, intensity] for heatmap
            const heatPoints = [];

            data.features.forEach(feature => {
                if (feature.geometry && feature.geometry.type === "Point") {
                    const coords = feature.geometry.coordinates;
                    const lat = coords[1];
                    const lng = coords[0];

                    let intensity = 1;
                    if (feature.properties) {
                        intensity = feature.properties.beds_total || 1;
                    }

                    heatPoints.push([lat, lng, intensity]);
                }
                else if (feature.geometry && feature.geometry.type === "Polygon") {
                }
            });

            heatLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 10,
                maxZoom: 17,
                max: 10, 
                gradient: {
                    0.1: 'rgba(0,0,255,0.6)',    // semi-transparent blue
                    0.3: 'rgba(0,255,255,0.7)',  // cyan
                    0.5: 'rgba(0,255,0,0.8)',    // green
                    0.7: 'rgba(255,255,0,0.9)',  // yellow
                    1.0: 'rgba(255,0,0,1.0)'     // red
                }
            });

            // Heatmap toggle checkbox listener
            document.getElementById('heatmap-toggle').addEventListener('change', e => {
                if (e.target.checked) {
                    map.addLayer(heatLayer);
                    heatLayer.bringToFront();
                } else {
                    map.removeLayer(heatLayer);
                }
            });
        });

</script>

</body>
</html>
