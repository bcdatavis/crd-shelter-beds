<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Shelter Beds Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }

        #layer-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            font-family: sans-serif;
            font-size: 14px;
            border-radius: 4px;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Layer toggle control -->
<div id="layer-toggle">
    <strong>Point Layers</strong><br>
    <label><input type="radio" name="layer" value="total" checked> Total Beds</label><br>
    <label><input type="radio" name="layer" value="yr_rnd"> Year-Round Beds - All Clients 19+</label><br>
    <label><input type="radio" name="layer" value="women"> Year-Round Beds - Women 19+ only</label><br>
    <label><input type="radio" name="layer" value="youth"> Year-Round Beds - Youth (15-25)</label><br>
    <label><input type="radio" name="layer" value="temp"> Temporary Beds - All Clients 19+</label><br><br>

    <strong>Polygon Layers</strong><br>
    <label><input type="checkbox" id="municipal-boundaries" checked> Legally Defined Administrative Areas of BC</label>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse for CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script>
    const map = L.map('map').setView([48.58842, -123.50967], 10);

    // Basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // --- WMS Polygon Layer ---
    const municipalLayer = L.tileLayer.wms('https://openmaps.gov.bc.ca/geo/pub/wms', {
        layers: 'pub:WHSE_LEGAL_ADMIN_BOUNDARIES.ABMS_MUNICIPALITIES_SP',
        styles: '410_5381',
        format: 'image/png',
        transparent: true,
        version: '1.1.1',
        srs: 'EPSG:4326',
        opacity: 0.5
    }).addTo(map);

    // --- Point layers ---
    const totalLayer = L.layerGroup().addTo(map);
    const yrRndLayer = L.layerGroup();
    const womenLayer = L.layerGroup();
    const youthLayer = L.layerGroup();
    const tempLayer = L.layerGroup();

    const csvUrl = 'https://raw.githubusercontent.com/bcdatavis/crd-shelter-beds/refs/heads/main/data/shelter_list.csv';

    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach(row => {
                const coord = row.coordinates?.trim();
                if (!coord) return;
                const [lng, lat] = coord.split(',').map(Number);
                if (isNaN(lat) || isNaN(lng)) return;

                const operator = row.operator_name || 'Unknown operator';
                const address = row.physical_address || 'Unknown address';

                const addMarker = (layer, value, color, fill) => {
                    if (!isNaN(value)) {
                        L.circleMarker([lat, lng], {
                            radius: Math.sqrt(value),
                            color: color,
                            fillColor: fill,
                            fillOpacity: 0.6,
                            weight: 1
                        }).bindPopup(`
                            <strong>${operator}</strong><br>
                            <strong>Address:</strong> ${address}<br>
                            <strong>Beds:</strong> ${value}
                        `).addTo(layer);
                    }
                };

                addMarker(totalLayer, parseInt(row.beds_total), 'blue', 'skyblue');
                addMarker(yrRndLayer, parseInt(row.beds_yr_rnd_all), 'darkred', 'salmon');
                addMarker(womenLayer, parseInt(row.beds_yr_rnd_women), 'purple', 'violet');
                addMarker(youthLayer, parseInt(row.beds_yr_rnd_youth), 'green', 'lightgreen');
                addMarker(tempLayer, parseInt(row.beds_temp), 'orange', 'gold');
            });
        }
    });

    // Layer toggle logic
    const layers = {
        total: totalLayer,
        yr_rnd: yrRndLayer,
        women: womenLayer,
        youth: youthLayer,
        temp: tempLayer
    };

    document.querySelectorAll('input[name="layer"]').forEach(radio => {
        radio.addEventListener('change', e => {
            const selected = e.target.value;
            Object.entries(layers).forEach(([key, layer]) => {
                if (key === selected) {
                    map.addLayer(layer);
                } else {
                    map.removeLayer(layer);
                }
            });
        });
    });

    // WMS Layer toggle
    document.getElementById('municipal-boundaries').addEventListener('change', function(e) {
        if (e.target.checked) {
            map.addLayer(municipalLayer);
        } else {
            map.removeLayer(municipalLayer);
        }
    });
</script>

</body>
</html>
